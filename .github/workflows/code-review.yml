name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # å®Ÿéš›ã®Gemini APIã‚’ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Gemini API dependencies
      run: |
        pip install google-generativeai requests

    - name: Gemini Code Review
      if: github.event_name == 'pull_request'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cat > gemini_review.py << 'EOF'
        import os
        import google.generativeai as genai
        import requests
        import json
        import sys
        
        def get_pr_diff():
            """PRã®å·®åˆ†ã‚’å–å¾—"""
            github_token = os.environ.get('GITHUB_TOKEN')
            repo = os.environ.get('GITHUB_REPOSITORY')
            pr_number = os.environ.get('GITHUB_EVENT_PATH')
            
            if pr_number:
                with open(pr_number, 'r') as f:
                    event_data = json.load(f)
                pr_num = event_data['pull_request']['number']
                
                # GitHub APIã§å·®åˆ†ã‚’å–å¾—
                headers = {
                    'Authorization': f'token {github_token}',
                    'Accept': 'application/vnd.github.v3.diff'
                }
                
                diff_url = f'https://api.github.com/repos/{repo}/pulls/{pr_num}'
                response = requests.get(diff_url, headers=headers)
                
                if response.status_code == 200:
                    return response.text
            
            return None
        
        def review_with_gemini(diff_content):
            """Gemini APIã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼"""
            api_key = os.environ.get('GEMINI_API_KEY')
            if not api_key:
                return "âŒ Gemini API key not found. Please set GEMINI_API_KEY secret."
            
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel('gemini-1.5-pro')
            
            prompt = f"""
            ã‚ãªãŸã¯Rustã¨Vulkanã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€è©³ç´°ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
            1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: ãƒ¡ãƒ¢ãƒªåŠ¹çŽ‡ã€ä¸è¦ãªã‚¯ãƒ­ãƒ¼ãƒ³ã€è¨ˆç®—åŠ¹çŽ‡
            2. **å®‰å…¨æ€§**: unsafeä½¿ç”¨ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§
            3. **ã‚³ãƒ¼ãƒ‰å“è³ª**: Rustãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€å¯èª­æ€§ã€ä¿å®ˆæ€§
            4. **Vulkan/Graphics**: GPUå‡¦ç†ã€ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã€åŒæœŸå‡¦ç†
            5. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆã€ä¾å­˜é–¢ä¿‚ã€æ‹¡å¼µæ€§

            ## PRå·®åˆ†:
            ```diff
            {diff_content}
            ```

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼å½¢å¼:
            - å…·ä½“çš„ãªå•é¡Œç‚¹ã¨ãã®ç†ç”±
            - æ”¹å–„ææ¡ˆã¨ã‚³ãƒ¼ãƒ‰ä¾‹
            - é‡è¦åº¦ï¼ˆHigh/Medium/Lowï¼‰
            - Rustã‚¤ãƒ‡ã‚£ã‚ªãƒ ã®æ´»ç”¨ææ¡ˆ

            æ—¥æœ¬èªžã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
            """
            
            try:
                response = model.generate_content(prompt)
                return response.text
            except Exception as e:
                return f"âŒ Gemini API error: {str(e)}"
        
        def main():
            diff = get_pr_diff()
            if not diff:
                print("No diff found")
                return
            
            # Rustãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã®ã¿ã‚’æŠ½å‡º
            rust_lines = [line for line in diff.split('\n') if '.rs' in line or line.startswith('+++') or line.startswith('---') or line.startswith('@@')]
            
            if not any('.rs' in line for line in rust_lines):
                review_result = "ã“ã®PRã«ã¯Rustãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            else:
                rust_diff = '\n'.join(rust_lines[:2000])  # é•·ã™ãŽã‚‹å ´åˆã¯åˆ¶é™
                review_result = review_with_gemini(rust_diff)
            
            # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            with open('gemini_review_result.md', 'w', encoding='utf-8') as f:
                f.write("## ðŸ¤– Gemini Code Review\n\n")
                f.write(review_result)
                f.write("\n\n---\n*Powered by Gemini 1.5 Pro*")
        
        if __name__ == "__main__":
            main()
        EOF
        
        python gemini_review.py

    - name: Post Gemini Review
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const review = fs.readFileSync('gemini_review_result.md', 'utf8');
            
            // æ—¢å­˜ã®Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŽ¢ã—ã¦å‰Šé™¤
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const geminiComments = comments.data.filter(comment => 
              comment.body.includes('ðŸ¤– Gemini Code Review')
            );
            
            // å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
            for (const comment of geminiComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });
            }
            
            // æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });
            
          } catch (error) {
            console.log('Error posting Gemini review:', error.message);
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Gemini Code Review failed. Please check the workflow logs.'
            });
          }

  code-analysis:
    name: Additional Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-analysis-${{ hashFiles('**/Cargo.lock') }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libx11-dev libxrandr-dev libxi-dev libgl1-mesa-dev libglu1-mesa-dev

    - name: Run Clippy for PR
      run: |
        cargo clippy --workspace --all-targets --all-features --message-format=json -- \
          -D warnings \
          -A clippy::too_many_arguments \
          -A clippy::if_same_then_else \
          -A clippy::items_after_test_module \
          -A clippy::map_clone \
          -A clippy::get_first \
          -A dead_code \
          -A unused_variables \
          -A unexpected_cfgs \
          > clippy-results.json || true

    - name: Post Clippy Results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const clippy = fs.readFileSync('clippy-results.json', 'utf8');
            const lines = clippy.split('\n').filter(line => line.trim());
            const warnings = lines
              .map(line => {
                try { return JSON.parse(line); } catch { return null; }
              })
              .filter(item => item && item.reason === 'compiler-message' && item.message.level === 'warning');
            
            if (warnings.length > 0) {
              const summary = warnings
                .slice(0, 10) // æœ€åˆã®10ä»¶ã®ã¿
                .map(w => `**${w.message.code?.code || 'clippy'}**: ${w.message.message}`)
                .join('\n');
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ¦€ Clippy Analysis Results\n\n${summary}\n\n${warnings.length > 10 ? `\n*... and ${warnings.length - 10} more warnings*` : ''}`
              });
            }
          } catch (error) {
            console.log('Clippy results not found or error parsing:', error.message);
          }

    - name: Check for unsafe code
      run: |
        echo "## ðŸ”’ Unsafe Code Analysis" > unsafe-analysis.md
        echo "" >> unsafe-analysis.md
        
        # Find unsafe blocks
        unsafe_count=$(find . -name "*.rs" -not -path "./target/*" -exec grep -l "unsafe" {} \; | wc -l)
        if [ $unsafe_count -gt 0 ]; then
          echo "Found unsafe code in $unsafe_count files:" >> unsafe-analysis.md
          find . -name "*.rs" -not -path "./target/*" -exec grep -Hn "unsafe" {} \; | head -20 >> unsafe-analysis.md
        else
          echo "âœ… No unsafe code found" >> unsafe-analysis.md
        fi

    - name: Post unsafe analysis
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const analysis = fs.readFileSync('unsafe-analysis.md', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: analysis
            });
          } catch (error) {
            console.log('Unsafe analysis not found:', error.message);
          }